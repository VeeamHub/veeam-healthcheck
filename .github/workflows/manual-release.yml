name: Manual Release

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to extract changelog from (optional)'
        required: false
        type: string
      version_override:
        description: 'Version override (leave empty to use AssemblyVersion from csproj)'
        required: false
        type: string
      skip_virustotal:
        description: 'Skip VirusTotal scan'
        required: false
        type: boolean
        default: false
      dry_run:
        description: 'Dry run - build but do not create release'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: read

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Restore dependencies
      run: dotnet restore vHC/HC.sln

    - name: Build solution
      run: dotnet build vHC/HC.sln --configuration Release --no-restore

    - name: Run tests
      run: dotnet test vHC/HC.sln --configuration Release --no-build --verbosity normal
      continue-on-error: true

    - name: Get version
      id: get_version
      shell: pwsh
      env:
        VERSION_OVERRIDE: ${{ inputs.version_override }}
      run: |
        if ("$env:VERSION_OVERRIDE" -ne "") {
          $version = "$env:VERSION_OVERRIDE"
          Write-Host "Using override version: $version"
        } else {
          $csproj = [xml](Get-Content vHC/HC_Reporting/VeeamHealthCheck.csproj)
          $version = $csproj.Project.PropertyGroup[0].AssemblyVersion
          Write-Host "Using AssemblyVersion from csproj: $version"
        }
        "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

    - name: Publish single-file executable
      shell: pwsh
      run: |
        dotnet publish vHC/HC_Reporting/VeeamHealthCheck.csproj `
          -c Release `
          -r win-x64 `
          --self-contained true `
          -p:PublishSingleFile=true `
          -p:IncludeNativeLibrariesForSelfExtract=true `
          -p:EnableCompressionInSingleFile=true `
          -o publish/out

    - name: Create ZIP archive
      shell: pwsh
      run: |
        $version = "${{ steps.get_version.outputs.version }}"
        Compress-Archive -Path publish/out/* -DestinationPath "publish/VeeamHealthCheck-$version.zip"
        Write-Host "Created: VeeamHealthCheck-$version.zip"

    - name: Compute file hash
      id: hash
      shell: pwsh
      run: |
        $version = "${{ steps.get_version.outputs.version }}"
        $zipPath = "publish/VeeamHealthCheck-$version.zip"
        $hash = (Get-FileHash $zipPath -Algorithm SHA256).Hash
        $sizeMB = [math]::Round((Get-Item $zipPath).Length / 1MB, 2)
        "hash=$hash" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        "size_mb=$sizeMB" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        Write-Host "SHA256: $hash"
        Write-Host "Size: $sizeMB MB"

    - name: VirusTotal Scan
      id: virustotal
      if: ${{ !inputs.skip_virustotal && vars.VT_API_KEY != '' }}
      shell: pwsh
      run: |
        $version = "${{ steps.get_version.outputs.version }}"
        $zipPath = "publish/VeeamHealthCheck-$version.zip"
        $apiKey = "${{ vars.VT_API_KEY }}"
        $headers = @{ "x-apikey" = $apiKey }
        $form = @{ file = Get-Item $zipPath }

        try {
          $uploadResponse = Invoke-RestMethod -Uri "https://www.virustotal.com/api/v3/files" -Method Post -Headers $headers -Form $form
          $analysisId = $uploadResponse.data.id
          Write-Host "Uploaded to VirusTotal. Analysis ID: $analysisId"

          $maxAttempts = 20
          $attempt = 0
          $analysisComplete = $false

          while (-not $analysisComplete -and $attempt -lt $maxAttempts) {
            Start-Sleep -Seconds 30
            $attempt++
            $analysisResponse = Invoke-RestMethod -Uri "https://www.virustotal.com/api/v3/analyses/$analysisId" -Headers $headers
            $status = $analysisResponse.data.attributes.status

            if ($status -eq "completed") {
              $analysisComplete = $true
              $stats = $analysisResponse.data.attributes.stats
              $malicious = $stats.malicious
              $suspicious = $stats.suspicious

              if ($malicious -eq 0 -and $suspicious -eq 0) {
                "vt_result=Clean (0 detections)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
                "vt_clean=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
              } else {
                "vt_result=WARNING: $malicious malicious, $suspicious suspicious" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
                "vt_clean=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
              }
              $fileHash = "${{ steps.hash.outputs.hash }}".ToLower()
              "vt_link=https://www.virustotal.com/gui/file/$fileHash" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            }
            Write-Host "Attempt $attempt/$maxAttempts - Status: $status"
          }

          if (-not $analysisComplete) {
            "vt_result=Scan timeout - check manually" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            "vt_clean=unknown" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          }
        } catch {
          "vt_result=Scan failed" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "vt_clean=error" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        }
      continue-on-error: true

    - name: Set VirusTotal defaults
      id: vt_defaults
      if: ${{ inputs.skip_virustotal || vars.VT_API_KEY == '' }}
      shell: pwsh
      env:
        SKIP_VIRUSTOTAL: ${{ inputs.skip_virustotal }}
      run: |
        if ("$env:SKIP_VIRUSTOTAL" -eq "true") {
          "vt_result=Skipped by user" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        } else {
          "vt_result=No API key configured" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        }
        "vt_clean=skipped" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

    - name: Get PR changelog
      id: changelog
      if: ${{ inputs.pr_number != '' }}
      shell: pwsh
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        PR_NUMBER: ${{ inputs.pr_number }}
      run: |
        $prNumber = "$env:PR_NUMBER"
        try {
          $prJson = gh pr view $prNumber --json title,body
          $pr = $prJson | ConvertFrom-Json
          $body = $pr.body

          # Write body to file for later use
          $body | Out-File -FilePath "pr_body.txt" -Encoding UTF8
          "pr_title=$($pr.title)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "has_changelog=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        } catch {
          "has_changelog=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        }

    - name: Generate release notes
      id: release_notes
      shell: pwsh
      run: |
        $version = "${{ steps.get_version.outputs.version }}"
        $hash = "${{ steps.hash.outputs.hash }}"
        $sizeMB = "${{ steps.hash.outputs.size_mb }}"
        $vtResult = if ("${{ steps.virustotal.outputs.vt_result }}") { "${{ steps.virustotal.outputs.vt_result }}" } else { "${{ steps.vt_defaults.outputs.vt_result }}" }
        $vtClean = if ("${{ steps.virustotal.outputs.vt_clean }}") { "${{ steps.virustotal.outputs.vt_clean }}" } else { "${{ steps.vt_defaults.outputs.vt_clean }}" }
        $commitSha = "${{ github.sha }}"
        $repo = "${{ github.repository }}"
        $buildDate = (Get-Date).ToString("yyyy-MM-ddTHH:mm:ssZ")

        $vtEmoji = switch ($vtClean) {
          "true" { "âœ…" }
          "false" { "âš ï¸" }
          "skipped" { "â­ï¸" }
          default { "â“" }
        }

        # Build release notes
        $notes = @()
        $notes += "## Veeam Health Check v$version"
        $notes += ""

        # Add changelog if available
        if (Test-Path "pr_body.txt") {
          $prBody = Get-Content "pr_body.txt" -Raw
          $notes += "### ðŸ†• What's New"
          $notes += ""
          $notes += $prBody
          $notes += ""
          $notes += "---"
          $notes += ""
        }

        $notes += "### âœ… Security & Quality Verification"
        $notes += "- âœ… Build & Unit Tests: **Passed**"
        $notes += "- $vtEmoji VirusTotal Scan: **$vtResult**"
        $notes += "- âœ… Code Quality: Analyzed"
        $notes += ""
        $notes += "### ðŸ“¦ Download"
        $notes += "**VeeamHealthCheck-$version.zip** ($sizeMB MB)"
        $notes += ""
        $notes += "**SHA256 Checksum:**"
        $notes += '```'
        $notes += $hash
        $notes += '```'
        $notes += ""
        $notes += "**Verification Command:**"
        $notes += '```powershell'
        $notes += "(Get-FileHash `"VeeamHealthCheck-$version.zip`").Hash"
        $notes += '```'
        $notes += ""
        $notes += "### ðŸ“‹ Requirements"
        $notes += "- Windows 7 or later"
        $notes += "- .NET 8 runtime (included in self-contained build)"
        $notes += "- PowerShell 5.1 or later"
        $notes += ""
        $notes += "### ðŸš€ Quick Start"
        $notes += "1. Download the ZIP file above"
        $notes += "2. Extract to a folder"
        $notes += "3. Run ``VeeamHealthCheck.exe``"
        $notes += ""
        $notes += "---"
        $notes += ""
        $notes += "**Built from:** [$commitSha](https://github.com/$repo/commit/$commitSha)"
        $notes += "**Build Date:** $buildDate"

        $notes -join "`n" | Out-File -FilePath "release_notes.md" -Encoding UTF8
        Write-Host "Generated release notes"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: veeam-healthcheck-${{ steps.get_version.outputs.version }}
        path: publish/VeeamHealthCheck-${{ steps.get_version.outputs.version }}.zip
        retention-days: 90

    - name: Create GitHub Release
      if: ${{ !inputs.dry_run }}
      shell: pwsh
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        $version = "${{ steps.get_version.outputs.version }}"
        $zipPath = "publish/VeeamHealthCheck-$version.zip"
        $notesFile = "release_notes.md"

        $existingRelease = gh release view "v$version" 2>&1
        if ($LASTEXITCODE -eq 0) {
          Write-Host "Release v$version already exists. Updating..."
          gh release edit "v$version" --notes-file $notesFile
          gh release upload "v$version" $zipPath --clobber
        } else {
          Write-Host "Creating new release v$version..."
          gh release create "v$version" --title "Veeam Health Check v$version" --notes-file $notesFile $zipPath
        }
        Write-Host "Release URL: https://github.com/${{ github.repository }}/releases/tag/v$version"

    - name: Dry run summary
      if: ${{ inputs.dry_run }}
      shell: pwsh
      run: |
        Write-Host "=== DRY RUN SUMMARY ==="
        Write-Host ""
        Write-Host "Version: ${{ steps.get_version.outputs.version }}"
        Write-Host "SHA256: ${{ steps.hash.outputs.hash }}"
        Write-Host "Size: ${{ steps.hash.outputs.size_mb }} MB"
        Write-Host ""
        Write-Host "=== RELEASE NOTES ==="
        Get-Content release_notes.md
        Write-Host ""
        Write-Host "=== END DRY RUN ==="
        Write-Host ""
        Write-Host "To create the actual release, run this workflow again with 'Dry run' unchecked."
