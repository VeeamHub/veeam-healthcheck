name: Manual Release

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to extract changelog from (optional)'
        required: false
        type: string
      version_override:
        description: 'Version override (leave empty to use AssemblyVersion from csproj)'
        required: false
        type: string
      skip_virustotal:
        description: 'Skip VirusTotal scan'
        required: false
        type: boolean
        default: false
      dry_run:
        description: 'Dry run - build but do not create release'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: read

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Restore dependencies
      run: dotnet restore vHC/HC.sln

    - name: Build solution
      run: dotnet build vHC/HC.sln --configuration Release --no-restore

    - name: Run tests
      run: |
        dotnet test vHC/HC.sln --configuration Release --no-build --verbosity normal
      continue-on-error: true

    - name: Get version
      id: get_version
      run: |
        if ("${{ inputs.version_override }}" -ne "") {
          $version = "${{ inputs.version_override }}"
          echo "Using override version: $version"
        } else {
          $csproj = [xml](Get-Content vHC/HC_Reporting/VeeamHealthCheck.csproj)
          $version = $csproj.Project.PropertyGroup[0].AssemblyVersion
          echo "Using AssemblyVersion from csproj: $version"
        }
        echo "version=$version" >> $env:GITHUB_OUTPUT

    - name: Publish single-file executable
      run: |
        dotnet publish vHC/HC_Reporting/VeeamHealthCheck.csproj `
          -c Release `
          -r win-x64 `
          --self-contained true `
          -p:PublishSingleFile=true `
          -p:IncludeNativeLibrariesForSelfExtract=true `
          -p:EnableCompressionInSingleFile=true `
          -o publish/out

    - name: Create ZIP archive
      run: |
        $version = "${{ steps.get_version.outputs.version }}"
        Compress-Archive -Path publish/out/* -DestinationPath "publish/VeeamHealthCheck-$version.zip"
        echo "Created: VeeamHealthCheck-$version.zip"

    - name: Compute file hash
      id: hash
      run: |
        $version = "${{ steps.get_version.outputs.version }}"
        $zipPath = "publish/VeeamHealthCheck-$version.zip"
        $hash = (Get-FileHash $zipPath -Algorithm SHA256).Hash
        $sizeMB = [math]::Round((Get-Item $zipPath).Length / 1MB, 2)
        echo "hash=$hash" >> $env:GITHUB_OUTPUT
        echo "size_mb=$sizeMB" >> $env:GITHUB_OUTPUT
        echo "SHA256: $hash"
        echo "Size: $sizeMB MB"

    - name: VirusTotal Scan
      id: virustotal
      if: ${{ !inputs.skip_virustotal && vars.VT_API_KEY != '' }}
      run: |
        $version = "${{ steps.get_version.outputs.version }}"
        $zipPath = "publish/VeeamHealthCheck-$version.zip"
        $apiKey = "${{ vars.VT_API_KEY }}"

        # Upload file to VirusTotal
        $headers = @{ "x-apikey" = $apiKey }
        $form = @{ file = Get-Item $zipPath }

        try {
          $uploadResponse = Invoke-RestMethod -Uri "https://www.virustotal.com/api/v3/files" -Method Post -Headers $headers -Form $form
          $analysisId = $uploadResponse.data.id
          echo "Uploaded to VirusTotal. Analysis ID: $analysisId"

          # Wait for analysis (poll every 30 seconds, max 10 minutes)
          $maxAttempts = 20
          $attempt = 0
          $analysisComplete = $false

          while (-not $analysisComplete -and $attempt -lt $maxAttempts) {
            Start-Sleep -Seconds 30
            $attempt++

            $analysisResponse = Invoke-RestMethod -Uri "https://www.virustotal.com/api/v3/analyses/$analysisId" -Headers $headers
            $status = $analysisResponse.data.attributes.status

            if ($status -eq "completed") {
              $analysisComplete = $true
              $stats = $analysisResponse.data.attributes.stats
              $malicious = $stats.malicious
              $suspicious = $stats.suspicious

              if ($malicious -eq 0 -and $suspicious -eq 0) {
                echo "vt_result=Clean (0 detections)" >> $env:GITHUB_OUTPUT
                echo "vt_clean=true" >> $env:GITHUB_OUTPUT
              } else {
                echo "vt_result=WARNING: $malicious malicious, $suspicious suspicious" >> $env:GITHUB_OUTPUT
                echo "vt_clean=false" >> $env:GITHUB_OUTPUT
              }

              # Get permalink
              $fileHash = "${{ steps.hash.outputs.hash }}".ToLower()
              echo "vt_link=https://www.virustotal.com/gui/file/$fileHash" >> $env:GITHUB_OUTPUT
            }
            echo "Attempt $attempt/$maxAttempts - Status: $status"
          }

          if (-not $analysisComplete) {
            echo "vt_result=Scan timeout - check manually" >> $env:GITHUB_OUTPUT
            echo "vt_clean=unknown" >> $env:GITHUB_OUTPUT
          }
        } catch {
          echo "vt_result=Scan failed: $($_.Exception.Message)" >> $env:GITHUB_OUTPUT
          echo "vt_clean=error" >> $env:GITHUB_OUTPUT
        }
      continue-on-error: true

    - name: Set VirusTotal defaults
      id: vt_defaults
      if: ${{ inputs.skip_virustotal || vars.VT_API_KEY == '' }}
      run: |
        if ("${{ inputs.skip_virustotal }}" -eq "true") {
          echo "vt_result=Skipped by user" >> $env:GITHUB_OUTPUT
        } else {
          echo "vt_result=No API key configured" >> $env:GITHUB_OUTPUT
        }
        echo "vt_clean=skipped" >> $env:GITHUB_OUTPUT

    - name: Get PR changelog
      id: changelog
      if: ${{ inputs.pr_number != '' }}
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        $prNumber = "${{ inputs.pr_number }}"

        try {
          $pr = gh pr view $prNumber --json title,body | ConvertFrom-Json

          # Extract key sections from PR body
          $body = $pr.body

          # Try to extract summary section
          $changelog = ""

          if ($body -match "(?s)## Summary(.*?)(?=##|$)") {
            $summary = $matches[1].Trim()
            # Clean up the summary - remove PR boilerplate
            $summary = $summary -replace "(?s)\[x\].*", ""
            $summary = $summary -replace "(?s)## Test Plan.*", ""
            $summary = $summary -replace "(?s)## Files Changed.*", ""
            $summary = $summary -replace "(?s)## Breaking Changes.*", ""
            $changelog = $summary.Trim()
          }

          if ($changelog -eq "") {
            $changelog = "See PR #$prNumber for details."
          }

          # Escape for GitHub Actions output
          $changelog = $changelog -replace "`r`n", "%0A"
          $changelog = $changelog -replace "`n", "%0A"
          $changelog = $changelog -replace "%", "%25"

          echo "changelog<<CHANGELOG_EOF" >> $env:GITHUB_OUTPUT
          echo "$($pr.body)" >> $env:GITHUB_OUTPUT
          echo "CHANGELOG_EOF" >> $env:GITHUB_OUTPUT
          echo "pr_title=$($pr.title)" >> $env:GITHUB_OUTPUT
        } catch {
          echo "changelog=See recent commits for changes." >> $env:GITHUB_OUTPUT
          echo "pr_title=" >> $env:GITHUB_OUTPUT
        }

    - name: Generate release notes
      id: release_notes
      run: |
        $version = "${{ steps.get_version.outputs.version }}"
        $hash = "${{ steps.hash.outputs.hash }}"
        $sizeMB = "${{ steps.hash.outputs.size_mb }}"
        $vtResult = if ("${{ steps.virustotal.outputs.vt_result }}" -ne "") { "${{ steps.virustotal.outputs.vt_result }}" } else { "${{ steps.vt_defaults.outputs.vt_result }}" }
        $vtClean = if ("${{ steps.virustotal.outputs.vt_clean }}" -ne "") { "${{ steps.virustotal.outputs.vt_clean }}" } else { "${{ steps.vt_defaults.outputs.vt_clean }}" }
        $prChangelog = @"
${{ steps.changelog.outputs.changelog }}
"@

        # Determine VT status emoji
        $vtEmoji = switch ($vtClean) {
          "true" { "âœ…" }
          "false" { "âš ï¸" }
          "skipped" { "â­ï¸" }
          default { "â“" }
        }

        # Build changelog section
        $changelogSection = ""
        if ("${{ inputs.pr_number }}" -ne "" -and $prChangelog -ne "") {
          # Extract just the key parts from PR body for the changelog
          $changelogSection = @"

### ðŸ†• What's New

$prChangelog

---

"@
        }

        $notes = @"
## Veeam Health Check v$version
$changelogSection
### âœ… Security & Quality Verification
- âœ… Build & Unit Tests: **Passed**
- $vtEmoji VirusTotal Scan: **$vtResult**
- âœ… Code Quality: Analyzed

### ðŸ“¦ Download
**VeeamHealthCheck-$version.zip** ($sizeMB MB)

**SHA256 Checksum:**
``````
$hash
``````

**Verification Command:**
``````powershell
(Get-FileHash "VeeamHealthCheck-$version.zip").Hash
``````

### ðŸ“‹ Requirements
- Windows 7 or later
- .NET 8 runtime (included in self-contained build)
- PowerShell 5.1 or later

### ðŸš€ Quick Start
1. Download the ZIP file above
2. Extract to a folder
3. Run ``VeeamHealthCheck.exe``

---

**Built from:** [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
**Build Date:** $((Get-Date).ToString("yyyy-MM-ddTHH:mm:ssZ"))
"@

        # Write to file for the release step
        $notes | Out-File -FilePath release_notes.md -Encoding UTF8
        echo "Generated release notes"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: veeam-healthcheck-${{ steps.get_version.outputs.version }}
        path: publish/VeeamHealthCheck-${{ steps.get_version.outputs.version }}.zip
        retention-days: 90

    - name: Create GitHub Release
      if: ${{ !inputs.dry_run }}
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        $version = "${{ steps.get_version.outputs.version }}"
        $zipPath = "publish/VeeamHealthCheck-$version.zip"
        $notes = Get-Content release_notes.md -Raw

        # Check if release already exists
        $existingRelease = gh release view "v$version" 2>&1
        if ($LASTEXITCODE -eq 0) {
          echo "Release v$version already exists. Updating..."
          gh release edit "v$version" --notes "$notes"
          gh release upload "v$version" $zipPath --clobber
        } else {
          echo "Creating new release v$version..."
          gh release create "v$version" `
            --title "Veeam Health Check v$version" `
            --notes "$notes" `
            $zipPath
        }

        echo "Release URL: https://github.com/${{ github.repository }}/releases/tag/v$version"

    - name: Dry run summary
      if: ${{ inputs.dry_run }}
      run: |
        echo "=== DRY RUN SUMMARY ==="
        echo ""
        echo "Version: ${{ steps.get_version.outputs.version }}"
        echo "SHA256: ${{ steps.hash.outputs.hash }}"
        echo "Size: ${{ steps.hash.outputs.size_mb }} MB"
        echo ""
        echo "=== RELEASE NOTES ==="
        Get-Content release_notes.md
        echo ""
        echo "=== END DRY RUN ==="
        echo ""
        echo "To create the actual release, run this workflow again with 'Dry run' unchecked."
